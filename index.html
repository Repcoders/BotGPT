<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intelligence Chat</title>
  <!-- Global Styles -->
  <style>
    :root {
      --bg-gradient: linear-gradient(160deg, rgba(255, 255, 255, 0.9) 0%, rgba(230, 236, 245, 0.7) 40%, rgba(210, 216, 225, 0.6) 100%);
      --bg-dark-gradient: linear-gradient(160deg, rgba(20, 24, 34, 0.9) 0%, rgba(26, 32, 46, 0.7) 50%, rgba(22, 28, 40, 0.6) 100%);
      --panel-glass: rgba(255, 255, 255, 0.25);
      --panel-border: rgba(255, 255, 255, 0.35);
      --panel-shadow: 0 20px 40px rgba(15, 26, 46, 0.2);
      --user-blue: #0A84FF;
      --assistant-gray: rgba(142, 142, 147, 0.85);
      --timestamp-color: rgba(60, 60, 67, 0.5);
      --nav-height: 72px;
      --radius-lg: 24px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, rgba(10, 132, 255, 0.2), transparent 45%),
        radial-gradient(circle at bottom, rgba(99, 110, 131, 0.25), transparent 50%),
        #0f172a;
      color: #0b1a33;
      font-family: inherit;
      -webkit-font-smoothing: antialiased;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0));
      pointer-events: none;
    }

    /* App Shell */
    .app {
      position: relative;
      width: min(960px, 100%);
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 32px clamp(16px, 5vw, 48px);
      gap: 24px;
    }

    /* Navigation Bar */
    .nav-bar {
      height: var(--nav-height);
      border-radius: var(--radius-lg);
      background: rgba(24, 32, 48, 0.55);
      backdrop-filter: blur(24px) saturate(140%);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 12px 30px rgba(6, 12, 24, 0.25);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 28px;
      color: rgba(240, 243, 248, 0.95);
      letter-spacing: -0.01em;
    }

    .nav-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 20px;
    }

    .nav-dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(10, 132, 255, 0.9) 0%, rgba(10, 132, 255, 0.3) 65%, transparent 100%);
      box-shadow: 0 0 14px rgba(10, 132, 255, 0.7);
    }

    .settings-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 18px;
      color: rgba(240, 243, 248, 0.95);
      padding: 10px 16px;
      font-size: 15px;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .settings-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.18);
    }

    /* Chat Panel */
    .chat-panel {
      flex: 1;
      position: relative;
      border-radius: calc(var(--radius-lg) + 6px);
      padding: 28px clamp(16px, 4vw, 36px);
      background: rgba(28, 36, 50, 0.55);
      backdrop-filter: blur(26px) saturate(160%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: var(--panel-shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .message-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      scroll-behavior: smooth;
    }

    .message-row {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      animation: fadeSlideUp 0.45s ease forwards;
      opacity: 0;
      transform: translateY(12px);
    }

    .message-row.user {
      align-items: flex-end;
    }

    .bubble {
      max-width: min(75%, 520px);
      padding: 14px 18px;
      border-radius: 24px;
      font-size: 16px;
      letter-spacing: -0.01em;
      line-height: 1.5;
      position: relative;
      display: inline-flex;
      gap: 10px;
      color: #f9fbff;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 12px 30px rgba(12, 22, 40, 0.2);
    }

    .bubble.user {
      background: linear-gradient(140deg, rgba(10, 132, 255, 0.95), rgba(10, 132, 255, 0.7));
    }

    .bubble.ai {
      background: linear-gradient(140deg, rgba(72, 80, 96, 0.9), rgba(80, 88, 105, 0.72));
    }

    .timestamp {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.55);
      letter-spacing: 0.01em;
    }

    .message-row.user .timestamp {
      text-align: right;
    }

    .bubble .copy-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.85);
      opacity: 0;
      cursor: pointer;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .bubble:hover .copy-btn {
      opacity: 1;
    }

    .bubble .copy-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.2);
    }

    .thinking {
      display: inline-flex;
      align-items: center;
      gap: 12px;
    }

    .thinking-dots {
      display: flex;
      gap: 4px;
    }

    .thinking-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.8);
      animation: blink 1.2s infinite ease-in-out;
    }

    .thinking-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .thinking-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    /* Composer */
    .composer {
      display: flex;
      align-items: center;
      gap: 16px;
      border-radius: calc(var(--radius-lg) + 4px);
      background: rgba(24, 32, 48, 0.6);
      backdrop-filter: blur(24px) saturate(140%);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 14px 18px 14px 20px;
      box-shadow: 0 18px 36px rgba(10, 20, 40, 0.25);
    }

    .composer input {
      flex: 1;
      border: none;
      background: rgba(255, 255, 255, 0.12);
      padding: 14px 18px;
      border-radius: 20px;
      color: rgba(240, 243, 248, 0.95);
      font-size: 16px;
      letter-spacing: -0.01em;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .composer input::placeholder {
      color: rgba(235, 238, 244, 0.5);
    }

    .composer input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.2);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.25);
    }

    .send-btn {
      background: linear-gradient(140deg, rgba(10, 132, 255, 0.95), rgba(90, 160, 255, 0.85));
      border: none;
      border-radius: 20px;
      padding: 12px 22px;
      color: #f7f9ff;
      font-weight: 600;
      letter-spacing: 0.01em;
      cursor: pointer;
      box-shadow: 0 14px 24px rgba(10, 132, 255, 0.35);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .send-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 28px rgba(10, 132, 255, 0.45);
    }

    /* Retry Block */
    .retry-block {
      align-self: center;
      padding: 8px 18px;
      border-radius: 18px;
      background: rgba(255, 96, 92, 0.15);
      border: 1px solid rgba(255, 96, 92, 0.4);
      color: rgba(255, 96, 92, 0.95);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      animation: fadeSlideUp 0.45s ease forwards;
      opacity: 0;
      transform: translateY(12px);
    }

    .retry-block button {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 16px;
      padding: 6px 12px;
      color: inherit;
      cursor: pointer;
      font-weight: 600;
    }

    /* Settings Sheet */
    .settings-sheet {
      position: fixed;
      left: 50%;
      bottom: -100%;
      transform: translateX(-50%);
      width: min(540px, calc(100% - 32px));
      background: rgba(22, 28, 40, 0.8);
      backdrop-filter: blur(30px) saturate(160%);
      border-radius: 32px 32px 24px 24px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 40px 60px rgba(8, 15, 32, 0.3);
      padding: 28px 32px 36px;
      color: rgba(240, 243, 248, 0.95);
      display: flex;
      flex-direction: column;
      gap: 20px;
      transition: bottom 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 20;
    }

    .settings-sheet.open {
      bottom: 24px;
    }

    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sheet-title {
      font-size: 20px;
      font-weight: 600;
    }

    .sheet-section {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .sheet-section label {
      font-size: 14px;
      letter-spacing: 0.01em;
      color: rgba(235, 238, 244, 0.82);
    }

    .sheet-section input,
    .sheet-section select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(255, 255, 255, 0.08);
      color: rgba(240, 243, 248, 0.95);
      font-size: 15px;
    }

    .sheet-section input[type="range"] {
      -webkit-appearance: none;
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.25);
    }

    .sheet-section input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(10, 132, 255, 0.95);
      box-shadow: 0 0 0 6px rgba(10, 132, 255, 0.25);
    }

    .sheet-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 8px;
    }

    .sheet-buttons button {
      border-radius: 18px;
      padding: 10px 18px;
      font-size: 15px;
      border: none;
      cursor: pointer;
    }

    .sheet-buttons .close-btn {
      background: rgba(255, 255, 255, 0.12);
      color: rgba(240, 243, 248, 0.85);
    }

    .sheet-buttons .save-btn {
      background: linear-gradient(140deg, rgba(10, 132, 255, 0.95), rgba(90, 160, 255, 0.85));
      color: #f7f9ff;
      font-weight: 600;
      box-shadow: 0 16px 28px rgba(10, 132, 255, 0.35);
    }

    .presets {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .preset-btn {
      border-radius: 16px;
      padding: 8px 14px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(255, 255, 255, 0.08);
      cursor: pointer;
      font-size: 14px;
      color: rgba(240, 243, 248, 0.85);
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .preset-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.16);
    }

    /* Toasts */
    .toast-container {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 30;
    }

    .toast {
      background: rgba(255, 96, 92, 0.92);
      color: #fff;
      padding: 12px 18px;
      border-radius: 18px;
      min-width: 220px;
      box-shadow: 0 20px 40px rgba(32, 0, 0, 0.25);
      font-size: 14px;
      animation: toastSlide 0.45s ease forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    /* Overlay */
    .sheet-overlay {
      position: fixed;
      inset: 0;
      background: rgba(6, 12, 24, 0.4);
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 15;
    }

    .sheet-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    /* Scrollbar Styling */
    .message-list::-webkit-scrollbar {
      width: 6px;
    }

    .message-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 999px;
    }

    /* Animations */
    @keyframes fadeSlideUp {
      0% {
        opacity: 0;
        transform: translateY(12px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes blink {
      0%, 80%, 100% {
        transform: scale(0.6);
        opacity: 0.3;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes toastSlide {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .app {
        padding: 24px 16px 16px;
      }

      .nav-bar {
        height: 64px;
        padding: 0 18px;
      }

      .chat-panel {
        padding: 18px 16px;
      }

      .composer {
        flex-direction: column;
        align-items: stretch;
      }

      .composer input {
        width: 100%;
      }

      .send-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Navigation Bar -->
    <header class="nav-bar">
      <div class="nav-title">
        <span class="nav-dot"></span>
        <span>Intelligence</span>
      </div>
      <button class="settings-btn" id="openSettings" aria-label="Open Settings">
        <span>‚öôÔ∏è</span>
        <span>Settings</span>
      </button>
    </header>

    <!-- Chat Panel -->
    <main class="chat-panel">
      <section class="message-list" id="messageList" aria-live="polite"></section>
      <div class="retry-area" id="retryArea"></div>
    </main>

    <!-- Composer -->
    <footer class="composer">
      <input id="messageInput" type="text" placeholder="Message Intelligence" autocomplete="off" />
      <button class="send-btn" id="sendBtn">Send</button>
    </footer>
  </div>

  <!-- Settings Overlay & Sheet -->
  <div class="sheet-overlay" id="sheetOverlay"></div>
  <aside class="settings-sheet" id="settingsSheet" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="sheet-header">
      <span class="sheet-title" id="settingsTitle">Settings</span>
      <span style="font-size: 14px; color: rgba(235, 238, 244, 0.6);">‚åò ,</span>
    </div>

    <!-- API Configuration Section -->
    <div class="sheet-section">
      <label for="apiKey">API Key</label>
      <input type="password" id="apiKey" placeholder="Enter Meganova API Key" />
    </div>

    <div class="sheet-section">
      <label for="endpoint">Endpoint URL</label>
      <input type="text" id="endpoint" value="https://inference.meganova.ai/v1/chat/completions" />
    </div>

    <div class="sheet-section">
      <label for="modelSelect">Model</label>
      <select id="modelSelect">
        <option value="meganova-ai/manta-mini-1.0">meganova-ai/manta-mini-1.0</option>
        <option value="meganova-ai/manta-flash-1.0">meganova-ai/manta-flash-1.0</option>
        <option value="zai-org/GLM-4.5-Air-Free">zai-org/GLM-4.5-Air-Free</option>
        <option value="BruhzWater/Sapphira-L3.3-70b-0.1">BruhzWater/Sapphira-L3.3-70b-0.1</option>
        <option value="FallenMerick/MN-Violet-Lotus-12B">FallenMerick/MN-Violet-Lotus-12B</option>
        <option value="Sao10K/L3-8B-Stheno-v3.2">Sao10K/L3-8B-Stheno-v3.2</option>
        <option value="Sao10K/L3-70B-Euryale-v2.1">Sao10K/L3-70B-Euryale-v2.1</option>
      </select>
    </div>

    <!-- Sampling Controls -->
    <div class="sheet-section">
      <label for="temperature">Temperature <span id="temperatureValue">1.0</span></label>
      <input type="range" id="temperature" min="0" max="2" step="0.1" value="1.0" />
    </div>

    <div class="sheet-section">
      <label for="topP">Top P <span id="topPValue">0.9</span></label>
      <input type="range" id="topP" min="0" max="1" step="0.05" value="0.9" />
    </div>

    <!-- Presets -->
    <div class="sheet-section">
      <label>Quick Presets</label>
      <div class="presets">
        <button class="preset-btn" data-temperature="1.0" data-top="0.9">Balanced</button>
        <button class="preset-btn" data-temperature="1.4" data-top="1.0">Creative</button>
        <button class="preset-btn" data-temperature="0.3" data-top="0.3">Precise</button>
      </div>
    </div>

    <div class="sheet-buttons">
      <button class="close-btn" id="closeSettings">Close</button>
      <button class="save-btn" id="saveSettings">Save</button>
    </div>
  </aside>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Application Script -->
  <script>
    // Meganova API URL constant (default)
    const DEFAULT_API_URL = "https://inference.meganova.ai/v1/chat/completions";

    // DOM Element References
    const messageList = document.getElementById("messageList");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const retryArea = document.getElementById("retryArea");
    const openSettingsBtn = document.getElementById("openSettings");
    const closeSettingsBtn = document.getElementById("closeSettings");
    const saveSettingsBtn = document.getElementById("saveSettings");
    const sheetOverlay = document.getElementById("sheetOverlay");
    const settingsSheet = document.getElementById("settingsSheet");
    const apiKeyInput = document.getElementById("apiKey");
    const endpointInput = document.getElementById("endpoint");
    const modelSelect = document.getElementById("modelSelect");
    const temperatureInput = document.getElementById("temperature");
    const temperatureValue = document.getElementById("temperatureValue");
    const topPInput = document.getElementById("topP");
    const topPValue = document.getElementById("topPValue");
    const toastContainer = document.getElementById("toastContainer");

    // Runtime State
    let lastUserMessage = "";
    let thinkingRow = null;

    // Local Storage Helpers
    const settingsKey = "intelligence.settings";

    function loadSettings() {
      const stored = localStorage.getItem(settingsKey);
      if (!stored) return;
      try {
        const parsed = JSON.parse(stored);
        if (parsed.apiKey) apiKeyInput.value = parsed.apiKey;
        if (parsed.endpoint) endpointInput.value = parsed.endpoint;
        if (parsed.model) modelSelect.value = parsed.model;
        if (typeof parsed.temperature === "number") {
          temperatureInput.value = parsed.temperature;
          temperatureValue.textContent = Number(parsed.temperature).toFixed(1);
        }
        if (typeof parsed.top_p === "number") {
          topPInput.value = parsed.top_p;
          topPValue.textContent = Number(parsed.top_p).toFixed(2);
        }
      } catch (error) {
        console.warn("Failed to parse settings", error);
      }
    }

    function saveSettings() {
      const payload = {
        apiKey: apiKeyInput.value.trim(),
        endpoint: endpointInput.value.trim() || DEFAULT_API_URL,
        model: modelSelect.value,
        temperature: Number(temperatureInput.value),
        top_p: Number(topPInput.value),
      };
      localStorage.setItem(settingsKey, JSON.stringify(payload));
      showToast("Settings Saved");
      closeSettings();
    }

    // Utility: format timestamp in Title Case style
    function formatTimestamp(date = new Date()) {
      const formatter = new Intl.DateTimeFormat("en-US", {
        hour: "numeric",
        minute: "2-digit"
      });
      return formatter.format(date);
    }

    // Utility: Scroll message list to bottom
    function scrollToBottom() {
      requestAnimationFrame(() => {
        messageList.scrollTop = messageList.scrollHeight;
      });
    }

    // Message Creation Helpers
    function createMessageRow(role, content, timestamp = new Date()) {
      const row = document.createElement("div");
      row.className = `message-row ${role}`;

      const bubble = document.createElement("div");
      bubble.className = `bubble ${role === "user" ? "user" : "ai"}`;

      const textSpan = document.createElement("span");
      textSpan.className = "bubble-text";
      textSpan.textContent = content;
      bubble.appendChild(textSpan);

      const copyBtn = document.createElement("button");
      copyBtn.className = "copy-btn";
      copyBtn.setAttribute("aria-label", "Copy Message");
      copyBtn.innerHTML = "üìã";
      copyBtn.addEventListener("click", () => copyText(content, bubble));
      bubble.appendChild(copyBtn);

      row.appendChild(bubble);

      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = formatTimestamp(timestamp);
      row.appendChild(time);

      return row;
    }

    function copyText(text, source) {
      navigator.clipboard.writeText(text).then(() => {
        source.classList.add("copied");
        showToast("Copied to Clipboard", { duration: 1500, tone: "neutral" });
        setTimeout(() => source.classList.remove("copied"), 1500);
      }).catch(() => {
        showToast("Copy Failed", { tone: "error" });
      });
    }

    // Typing Indicator Management
    function showThinkingIndicator() {
      const row = document.createElement("div");
      row.className = "message-row ai";

      const bubble = document.createElement("div");
      bubble.className = "bubble ai thinking";
      bubble.innerHTML = `<span>Thinking‚Ä¶</span><div class="thinking-dots"><span></span><span></span><span></span></div>`;
      row.appendChild(bubble);

      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = formatTimestamp();
      row.appendChild(time);

      messageList.appendChild(row);
      scrollToBottom();
      return row;
    }

    function replaceThinkingWithResponse(row, text) {
      if (!row) return;
      const bubble = row.querySelector(".bubble");
      const timestamp = row.querySelector(".timestamp");
      if (bubble) {
        bubble.classList.remove("thinking");
        bubble.textContent = "";

        const textSpan = document.createElement("span");
        textSpan.className = "bubble-text";
        textSpan.textContent = text;
        bubble.appendChild(textSpan);

        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn";
        copyBtn.setAttribute("aria-label", "Copy Message");
        copyBtn.innerHTML = "üìã";
        copyBtn.addEventListener("click", () => copyText(text, bubble));
        bubble.appendChild(copyBtn);
      }
      if (timestamp) timestamp.textContent = formatTimestamp();
      scrollToBottom();
    }

    function removeThinkingIndicator(row) {
      if (row && row.parentElement) {
        row.parentElement.removeChild(row);
      }
    }

    // Toast Notifications
    function showToast(message, { duration = 2800, tone = "error" } = {}) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      if (tone === "neutral") {
        toast.style.background = "rgba(72, 80, 96, 0.95)";
        toast.style.boxShadow = "0 20px 40px rgba(6, 12, 24, 0.25)";
      }
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateY(20px)";
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Retry Handling
    function showRetryOption(message) {
      retryArea.innerHTML = "";
      const block = document.createElement("div");
      block.className = "retry-block";
      block.innerHTML = `<span>Delivery failed.</span>`;
      const button = document.createElement("button");
      button.textContent = "Retry";
      button.addEventListener("click", () => {
        retryArea.innerHTML = "";
        sendMessageFlow(message);
      });
      block.appendChild(button);
      retryArea.appendChild(block);
      requestAnimationFrame(() => {
        block.style.opacity = "1";
        block.style.transform = "translateY(0)";
      });
    }

    // Settings Sheet Controls
    function openSettings() {
      settingsSheet.classList.add("open");
      sheetOverlay.classList.add("show");
    }

    function closeSettings() {
      settingsSheet.classList.remove("open");
      sheetOverlay.classList.remove("show");
    }

    function toggleSettings(force) {
      if (force === true) {
        openSettings();
        return;
      }
      if (force === false) {
        closeSettings();
        return;
      }
      if (settingsSheet.classList.contains("open")) {
        closeSettings();
      } else {
        openSettings();
      }
    }

    // Send Message Flow
    async function sendMessageFlow(message) {
      const trimmed = message.trim();
      if (!trimmed) {
        showToast("Enter A Message");
        return;
      }
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        showToast("Add API Key In Settings");
        openSettings();
        return;
      }
      const endpoint = endpointInput.value.trim() || DEFAULT_API_URL;
      const model = modelSelect.value;
      const temperature = Number(temperatureInput.value);
      const top_p = Number(topPInput.value);

      lastUserMessage = trimmed;

      const userRow = createMessageRow("user", trimmed);
      messageList.appendChild(userRow);
      scrollToBottom();

      retryArea.innerHTML = "";
      thinkingRow = showThinkingIndicator();

      try {
        const reply = await sendMessage(trimmed, model, apiKey, temperature, top_p, endpoint);
        replaceThinkingWithResponse(thinkingRow, reply);
        thinkingRow = null;
      } catch (error) {
        removeThinkingIndicator(thinkingRow);
        thinkingRow = null;
        showRetryOption(trimmed);
        showToast(error.message || "Request Failed");
        if (error.message.includes("CORS")) {
          showToast("This endpoint blocks browser requests. Use a proxy (e.g., Vercel/Cloudflare Worker).", { duration: 4500 });
        }
      }
    }

    // API Call Wrapper
    async function sendMessage(message, model, apiKey, temperature, top_p, endpoint = DEFAULT_API_URL) {
      const headers = {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`,
      };

      const body = {
        messages: [{ role: "user", content: message }],
        model,
        temperature,
        top_p,
        stream: false,
      };

      try {
        const res = await fetch(endpoint || DEFAULT_API_URL, {
          method: "POST",
          headers,
          body: JSON.stringify(body),
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(`${res.status}: ${data.error || res.statusText}`);
        }

        return data.choices[0]?.message?.content || "";
      } catch (err) {
        console.error("API Error:", err);
        throw new Error(err.message.includes("CORS") ? "CORS blocked ‚Äî use a proxy" : err.message);
      }
    }

    // Event Listeners
    sendBtn.addEventListener("click", () => {
      const message = messageInput.value;
      messageInput.value = "";
      sendMessageFlow(message);
    });

    messageInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendBtn.click();
      }
    });

    openSettingsBtn.addEventListener("click", () => toggleSettings(true));
    closeSettingsBtn.addEventListener("click", () => toggleSettings(false));
    sheetOverlay.addEventListener("click", () => toggleSettings(false));
    saveSettingsBtn.addEventListener("click", saveSettings);

    temperatureInput.addEventListener("input", (event) => {
      temperatureValue.textContent = Number(event.target.value).toFixed(1);
    });

    topPInput.addEventListener("input", (event) => {
      topPValue.textContent = Number(event.target.value).toFixed(2);
    });

    document.querySelectorAll(".preset-btn").forEach((button) => {
      button.addEventListener("click", () => {
        const temp = Number(button.dataset.temperature);
        const top = Number(button.dataset.top);
        temperatureInput.value = temp;
        topPInput.value = top;
        temperatureValue.textContent = temp.toFixed(1);
        topPValue.textContent = top.toFixed(2);
      });
    });

    // Keyboard Shortcuts
    window.addEventListener("keydown", (event) => {
      if ((event.metaKey || event.ctrlKey) && event.key === ",") {
        event.preventDefault();
        toggleSettings();
      }
    });

    // Initial Load
    loadSettings();
    messageInput.focus();
  </script>
</body>
</html>
